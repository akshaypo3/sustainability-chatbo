name: Build & Deploy to SAP AI Core

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    # Checkout repo
    - name: Checkout repo
      uses: actions/checkout@v3

    # Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Install jq for JSON parsing
    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y jq curl

    # Log in to DockerHub
    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Build Docker image
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/sustainability-chatbo:latest .

    # Push Docker image
    - name: Push Docker image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/sustainability-chatbo:latest

    # Debug: Check if secrets are set correctly (without revealing values)
    - name: Debug - Check secrets existence
      run: |
        echo "Checking if required secrets are set..."
        secrets=("AI_API_URL" "AUTH_URL" "CLIENT_ID" "CLIENT_SECRET" "DOCKERHUB_USERNAME" "DOCKERHUB_TOKEN" "SUPABASE_URL" "SUPABASE_KEY" "GEMINI_API_KEY")
        
        for secret in "${secrets[@]}"; do
          if [ -n "${!secret}" ]; then
            echo "✓ $secret is set"
          else
            echo "✗ $secret is NOT set or empty"
            exit 1
          fi
        done

    # Debug: Check authentication URL format
    - name: Debug - Check auth URL format
      run: |
        echo "Auth URL: ${{ secrets.AUTH_URL }}"
        # Check if it contains /oauth/token
        if [[ "${{ secrets.AUTH_URL }}" != *"/oauth/token" ]]; then
          echo "WARNING: Auth URL might need /oauth/token suffix"
          echo "Trying with /oauth/token suffix..."
          echo "AUTH_URL_WITH_SUFFIX=${{ secrets.AUTH_URL }}/oauth/token" >> $GITHUB_ENV
        else
          echo "AUTH_URL_WITH_SUFFIX=${{ secrets.AUTH_URL }}" >> $GITHUB_ENV
        fi

    # Deploy to SAP AI Core using Direct API
    - name: Deploy to SAP AI Core via API
      run: |
        # Get access token with better error handling
        echo "Getting access token from SAP..."
        echo "Auth URL: $AUTH_URL_WITH_SUFFIX"
        echo "Client ID: ${{ secrets.CLIENT_ID }}"
        
        TOKEN_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "$AUTH_URL_WITH_SUFFIX" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials&client_id=${{ secrets.CLIENT_ID }}&client_secret=${{ secrets.CLIENT_SECRET }}")
        
        # Extract HTTP status and response body
        HTTP_STATUS=$(echo "$TOKEN_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
        RESPONSE_BODY=$(echo "$TOKEN_RESPONSE" | sed '/HTTP_STATUS:/d')
        
        echo "HTTP Status: $HTTP_STATUS"
        echo "Response: $RESPONSE_BODY"
        
        if [ "$HTTP_STATUS" != "200" ]; then
          echo "ERROR: Failed to get access token. HTTP Status: $HTTP_STATUS"
          echo "Please check:"
          echo "1. AUTH_URL is correct (should be like: https://<your-domain>.authentication.<region>.hana.ondemand.com/oauth/token)"
          echo "2. CLIENT_ID and CLIENT_SECRET are correct"
          echo "3. Your service key has proper permissions"
          exit 1
        fi
        
        ACCESS_TOKEN=$(echo "$RESPONSE_BODY" | jq -r '.access_token')
        
        if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "ERROR: Failed to extract access token from response"
          exit 1
        fi
        
        echo "Successfully obtained access token"

        # Create secrets using API
        echo "Creating Supabase secret..."
        SUPABASE_SECRET_PAYLOAD=$(jq -n \
          --arg url "${{ secrets.SUPABASE_URL }}" \
          --arg key "${{ secrets.SUPABASE_KEY }}" \
          '{
            "name": "supabase-secret",
            "data": {"SUPABASE_URL": $url, "SUPABASE_KEY": $key},
            "labels": {"ai.sap.com/resourcePlan": "free"}
          }')
        
        curl -v -X POST "${{ secrets.AI_API_URL }}/v2/admin/secrets" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "$SUPABASE_SECRET_PAYLOAD"
        
        echo "Creating Gemini secret..."
        GEMINI_SECRET_PAYLOAD=$(jq -n \
          --arg key "${{ secrets.GEMINI_API_KEY }}" \
          '{
            "name": "gemini-secret",
            "data": {"GEMINI_API_KEY": $key},
            "labels": {"ai.sap.com/resourcePlan": "free"}
          }')
        
        curl -v -X POST "${{ secrets.AI_API_URL }}/v2/admin/secrets" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "$GEMINI_SECRET_PAYLOAD"
        
        echo "Creating Docker registry secret..."
        DOCKER_AUTH=$(echo -n "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" | base64 | tr -d '\n')
        DOCKER_CONFIG=$(jq -n \
          --arg server "https://index.docker.io/v1/" \
          --arg username "${{ secrets.DOCKERHUB_USERNAME }}" \
          --arg password "${{ secrets.DOCKERHUB_TOKEN }}" \
          --arg auth "$DOCKER_AUTH" \
          '{
            "auths": {
              ($server): {
                "username": $username,
                "password": $password,
                "auth": $auth
              }
            }
          }')
        
        DOCKER_SECRET_PAYLOAD=$(jq -n \
          --argjson data "$DOCKER_CONFIG" \
          '{
            "name": "docker-registry-secret",
            "type": "kubernetes.io/dockerconfigjson",
            "data": $data,
            "labels": {"ai.sap.com/resourcePlan": "free"}
          }')
        
        curl -v -X POST "${{ secrets.AI_API_URL }}/v2/admin/secrets" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "$DOCKER_SECRET_PAYLOAD"
        
        # Create workflow template
        echo "Creating workflow template..."
        
        # Read and modify the workflow template
        WORKFLOW_TEMPLATE=$(cat sap_ai_core_deployment.yaml | sed -n '/^apiVersion: argoproj.io\/v1alpha1/,/^---$/p' | head -n -1 | sed "s/\${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_USERNAME }}/g")
        
        curl -v -X POST "${{ secrets.AI_API_URL }}/v2/admin/workflowtemplates" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/yaml" \
          --data-binary "$WORKFLOW_TEMPLATE"
        
        # Create deployment
        echo "Creating deployment..."
        
        # Read the deployment manifest
        DEPLOYMENT_MANIFEST=$(cat sap_ai_core_deployment.yaml | sed -n '/^apiVersion: ai.sap.com\/v1alpha1/,/$/p')
        
        curl -v -X POST "${{ secrets.AI_API_URL }}/v2/lm/deployments" \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/yaml" \
          --data-binary "$DEPLOYMENT_MANIFEST"
        
        echo "Deployment completed successfully!"

    # Verify deployment
    - name: Verify Deployment
      run: |
        # Get access token again for verification
        TOKEN_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "$AUTH_URL_WITH_SUFFIX" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "grant_type=client_credentials&client_id=${{ secrets.CLIENT_ID }}&client_secret=${{ secrets.CLIENT_SECRET }}")
        
        HTTP_STATUS=$(echo "$TOKEN_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
        RESPONSE_BODY=$(echo "$TOKEN_RESPONSE" | sed '/HTTP_STATUS:/d')
        
        if [ "$HTTP_STATUS" = "200" ]; then
          ACCESS_TOKEN=$(echo "$RESPONSE_BODY" | jq -r '.access_token')
          
          # Check deployment status
          echo "Checking deployment status..."
          DEPLOYMENTS=$(curl -s -X GET "${{ secrets.AI_API_URL }}/v2/lm/deployments" \
            -H "Authorization: Bearer $ACCESS_TOKEN")
          
          echo "Deployments:"
          echo "$DEPLOYMENTS" | jq .
        else
          echo "Could not verify deployment status (auth failed)"
        fi
        
        echo -e "\nDeployment process completed!"
        echo "Check your SAP AI Core cockpit for detailed status."
        